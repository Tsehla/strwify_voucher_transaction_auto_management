<!DOCTYPE html>
<html>

	<head>

		<title>mikrotik hotspot > status</title>
	
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>

		<link rel="stylesheet" href="bootstrap.min.css">

		<link rel="stylesheet" href="line-awesome/css/line-awesome.css">

	</head>

	<body>
		

		<div id='classic_menu_skin' style="width:100%;height:auto;font-size: 16px;">

			<div style="width: 100vw;height: 10vh;min-height: 40px;line-height: 40px;border-bottom: 1px solid grey;align-content: center" class="btn"><p  style="width: auto;">Welcome :<span id='welcome_user_name' style="color:blue;padding-left: 5px;font-weight: 400"></span></p></div>
			
			<div style="width: 100vw;height: 10vh;min-height: 40px;line-height: 40px;border-bottom: 1px solid grey;align-content: center" class="btn"><p  style="width: auto;">IP address :<span id='ip_address' style="color:blue;padding-left: 5px;font-weight: 400"></span></p></div>
			

			<div style="width: 100vw;height: 10vh;min-height: 40px;line-height: 40px;border-bottom: 1px solid grey;align-content: center" class="btn"><p  style="width: auto;">Data available :<span id='data_available' style="color:blue;padding-left: 5px;font-weight: 400"></span></p></div> 
			
			<div style="width: 100vw;height: 10vh;min-height: 40px;line-height: 40px;border-bottom: 1px solid grey;align-content: center" class="btn"><p  style="width: auto;">Data uploaded / downloaded :<span id='bytes_up_down' style="color:blue;padding-left: 5px;font-weight: 400"></span></p></div>
			
			<div style="width: 100vw;height: 10vh;min-height: 40px;line-height: 40px;border-bottom: 1px solid grey;align-content: center" class="btn"><p  style="width: auto;">Connection time used / left :<span id='connection_time' style="color:blue;padding-left: 5px;font-weight: 400"></span></p></div>
			
			<div style="width: 100vw;height: 10vh;min-height: 40px;line-height: 40px;border-bottom: 1px solid grey;align-content: center" class="btn"><p  style="width: auto;">status refreshes in :<span id='to_before_refresh' style="color:blue;padding-left: 5px;font-weight: 400"></span></p>
			
			<div style="width: 100%;height: 20vh;min-height:100px;max-width: 543px;margin: 14px auto;">

				<button class='btn' style="width: 46%;height: 50px;margin:0px 0px 10px 10px;display: inline-block;font-weight: 900; line-height: 30px" onclick='page_refresh()'>Update Status</button>
				
				<div style="width: 100%;height: 10vh;min-height:50px;">

					<button class='btn btn-danger' onclick="window.open(router_variables_array.logout_link+'?erase-cookie=1','_self')" style="width: 44%;height: 50px;margin:0px 10px 10px 2.2vw;display: inline-block;font-weight: 900; line-height: 30px">Log out</button>
					<button class='btn btn-warning' onclick="window.open(http_https + window.location.host + '/transaction?hotspot_link=' + router_login_link + '&hotspot_location=' + router_variables_array['location'],'_self')" style="width: 46%;height: 50px;margin:0px 0px 10px 10px;display: inline-block;font-weight: 900; line-height: 30px">Buy</button>

				</dic>
				
			</div>	
			
		</div>



		<!-- dak neumoph skin -->








		<!-- +++++++ get variable from router encoded on link  +++++++ -->
		<script type="text/javascript" src="/qs.js"></script>
		<script type='text/JavaScript' src='jquery-3.3.1.min.js' ></script> 
		<script>


			var current_url= window.location.pathname;//content after domain 
			var current_domain = window.location.host;//domain en port//use this on live

			// //change https to http when on localhost
			// var http_https = "http://";

			// if(current_domain.search('127.0.0.1') > -1 || current_domain.search('localhost') > -1){//match exist

			// 	http_https = 'http://';//return http
			// }
			//change protocol to unsecured if coming from unsecured site ::
			var http_https = "https://"; 

			if(location.protocol === 'http:'){
				http_https = 'http://';//return http
			}
			
			
			//EXAMPLE LINK WITH PAYLOAD // for developing local
			//http://127.0.0.1:3100/hotspot_status?status=true&refresh_timeout_seconds=60&advert_link=http://wifi.com/advert&logout_link=http://wifi.com/logout&user_name=usbwalt&ip_address=192.168.88.252&data_uploaded=114%20B&data_downloaded=96%20B&connection_time_used=0s&connection_time_left=&up_time=0s&refresh_time=1m&data_available=1277.5%20MiB&link-login-only=http://wifi.com/login&location=orangefarm
			
			//get varibles from router on link
			var router_variables_array = qs.get();
			
			//console.log(router_variables_array);
			var router_login_link = router_variables_array['link-login-only'];//login link of router
			var router_location = router_variables_array['location'];//login link of router
			
			//fill with data from router
			

			var welcome_user_name = router_variables_array.user_name;
			var ip_address = router_variables_array.ip_address;
			var bytes_up_down = router_variables_array.data_uploaded+' / ' + router_variables_array.data_downloaded; //to clean 

			if(bytes_up_down){ //clean
				bytes_up_down = bytes_up_down.replace(/%20/g,' ').replace(/%3/g,'');
			}

			var connection_time_used = router_variables_array.connection_time_used;
			var connection_time_available = router_variables_array.connection_time_left;
			var to_before_refresh = router_variables_array.refresh_time;

			var data_available = router_variables_array.data_available.replace(/%20/g,' ');

			if(data_available){//clean
				data_available = data_available.replace(/%20/g,' ');
			}

			document.getElementById('welcome_user_name').innerHTML= welcome_user_name +'!';
			document.getElementById('ip_address').innerHTML= ip_address;
			document.getElementById('bytes_up_down').innerHTML= bytes_up_down;
			document.getElementById('connection_time').innerHTML= connection_time_used +' / ' + connection_time_available;
			document.getElementById('to_before_refresh').innerHTML= to_before_refresh;
			document.getElementById('data_available').innerHTML= data_available;
		
			
			
			//console.log(router_variables_array.refresh_timeout_seconds)
			
			//refresh window

			function page_refresh(){
				
				window.open(router_variables_array['link-login-only'].replace('logout','status'),'_self');
				
			}
			
			setInterval(function(){
				
				window.open(router_variables_array['link-login-only'].replace('logout','status'),'_self');
				
			}, ((router_variables_array.refresh_timeout_seconds * 60)*60))


			// ****** give iframe hotspot location when this window is called as an i frame in order to check if seller is still in their owned hotspot//this page will not be called direct, mikrotik hotspot login link will be called and mikrotik will respond with re-direct to external hotspot page, which will be this
			
			window.parent.postMessage(['router_hotspot_location', router_variables_array["location"]], '*');
			
		
			//++++++++++++++++++ connect to db ++++++++++++++
			var hot_spot_db_url = '/api/hotspot_data?location='+ router_location;
				
			//console.log(hot_spot_db_url) ;	
				
			$.get(hot_spot_db_url, function(response, status){
				
				if(status == 'success'){
					console.log(JSON.stringify(response));
					//    fill_data_from_db(response);//start with data from db function
					return;
				}

				else{
						console.log('Error retrieving data from db for hotspot') ;
						fill_data_from_db();//start with no data from db function
						return;
				}         
			});





		</script>
		
	</body>
</html>
